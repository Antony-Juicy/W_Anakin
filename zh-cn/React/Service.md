## 测试环境问题排查的那些事儿

**排查实践**

**案例一** **问题：**测试环境一个查询商品列表的接口，响应非常慢，经常超时。

**总结：**这个案例充分展示了合理使用工具的重要性。通过服务管理平台，能够快速确认服务是正常的，问题在于部分接口；通过 zzapm 强大的调用链追踪能力，能准确定位到耗时的节点，确定问题原因。

**案例二 问题：某 RPC 服务，部署后启动失败。**

**排查过程：**

- Step 1：查看服务进程，发现进程不存在；查看服务日志，发现没有生成日志；
- Step 2：查看 Java 虚拟机日志，发现在日志中间有一条异常输出，表明服务的端口被占用了；

**总结：**端口冲突的问题，曾经在测试环境频繁出现，给我们制造了很多麻烦。通过在排查过程中不断分析和总结，我们确定了问题的根本原因在于端口使用的不规范。进而制定并推广了服务端口的分配规范，只允许使用指定范围内的监听端口，并在测试环境中对这些端口进行了预留，从而彻底解决了这一问题。

## 大文件切片上传+断点续传

1. 文件格式校验

2. 文件切片、md5 计算

3. 发起检查请求，把当前文件的 hash 发送给服务端，检查是否有相同 hash 的文件

4. 上传进度计算

5. 上传完成后通知后端合并切片

## 支付流程

商品金额发改后端，后端对比之后加密返回给我订单信息

我收到加密后的信息，发给支付宝，该怎么支付怎么支付

支付完成之后，支付宝会给移动端和客后端分别发送支付信息

然后前端把收到的信息发给后端进行对比

后端对比成功，更改自己订单状态

## 扫码登录

1、前端点击生成二维码按钮或点击相关链接

2、该网页生成唯一个 id 的二维码，关闭该页面或每次刷新后都会改变。

3、浏览器把这个 id 通知给服务器，告诉服务器有这个二维码

4、服务器知道了这个 id,和浏览器建立长轮询，等待有人扫这个二维码

5、有人扫了这个二维码，浏览器(通过长轮询）查询到这个 id 的扫描记录（并得到 201 返回码），立刻通知服务器有人扫了

6、手机扫描后进入了新的页面，同时也可以在手机上直接和服务器进行资源交换了
在第 5 步，如果一直没人扫，长轮询检测不到有人扫描，会接到状态码 408（请求超时），页面可以设计成提醒”二维码已过期请刷新”
